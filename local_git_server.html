<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="assets/portal.ico">
  <title>Local Git Server -- Homelab | Hylown</title>
  <link rel="stylesheet" href="assets/css/hylowncom.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
</head>
<body>

  <header class="header top-bar">
    <div class="wrapper no-pad">
      <ul class="navigation">
        <li class="hamburger-icon"><a href="javascript:void(0)" onclick="toggleNav()"><span>&nbsp;</span><span>&nbsp;</span><span>&nbsp;</span></a></li>
        <li style="padding:0;"><a style="padding:0;margin:0 10;" href="https://hylown.com"><img src="assets/portal.png" width="31px" height="31px"></a></li>
        <li><a href="homelab.html">Homelab</a></li>
        <li><a href="apps.html">Apps</a></li>
        <li><a href="consulting.html">Consulting</a></li>
        <li><a style="font-size:1.5em;" href=""><i class="bi bi-linkedin"></i></a></li>
        <li><a style="font-size:1.5em;" href=""><i class="bi bi-github"></i></a></li>
        <li><a href="buy_us_a_coffee.html">Support Us</a></li>
      </ul>
    </div>
  </header>

  <div class="container">
    <main class="main">
        <div class="main__inner grid">
            <div class="sidebar sidebar--primary" id="sidebar--primary">
                <div class="sidebar__scrollwrap">
                    <div class="sidebar__inner sidebar__inner-left">
                      <div>
                        <label>Homelab</label>
                        <a href="javascript:void(0)" class="closebtn" id="closebtn" onclick="toggleNav()" style="display:none;">&times;</a>
                      </div>
                      <ul class="side-nav">
                        <li><a id="Home" href="homelab.html">Home</a></li>
                        <li><a id="SSH" href="ssh.html">SSH</a></li>
                        <li><a id="RaspberryPi" href="raspberry_pi.html">Raspberry Pi</a>
                          <ul class="side-nav side-nav-2">
                            <li><a id="RaspberryPi-Initialize" href="raspberry_pi_initialize.html">Initialize</a></li>
                            <li><a id="RaspberryPi-PCIE" href="raspberry_pi_pcie.html">PCIe Boot NVMe</a></li>
                            <li><a id="Extras" href="raspberry_pi_extras.html">Extras</a></li>
                          </ul>
                        </li>
                        <li><a id="LocalHTTPServer" href="local_http_server.html">Local HTTP Server</a></li>
                        <li><a id="LocalGitServer" href="local_git_server.html">Local Git Server</a></li>
                        <li><a id="RemoteGitServer" href="remote_git_server.html">Remote Git Server</a></li>
                      </ul>
                    </div>
                </div>
            </div>
            <div class="sidebar sidebar--secondary" style="top:48px;">
                <div class="sidebar__scrollwrap">
                    <div class="sidebar__inner">
                      <div>
                        <label>On this page</label>
                      </div>
                      <ul class="side-nav template__nav" id="right-nav">
                        <li><a href="">back to top</a></li>
                        <li class="template__nav-item"><a href="#features">Features</a></li>
<li class="template__nav-item"><a href="#machines">Machines</a></li>
<li class="template__nav-item"><a href="#software-used">Software used</a></li>
<li class="template__nav-item"><a href="#minimal-config">Minimal config</a></li>
<li class="template__nav-item"><a href="#repo-root">Repo root</a></li>
<li class="template__nav-item"><a href="#gitweb-config">Gitweb Config</a></li>
<li class="template__nav-item"><a href="#creating-a-new-repo">Creating a new repo</a></li>
<li class="template__nav-item"><a href="#ssh-without-a-password">SSH without a password</a></li>
<li class="template__nav-item"><a href="#httpphp-form">HTTP/PHP Form</a></li>
<li class="template__nav-item"><a href="#finalize">Finalize</a></li>
<li class="template__nav-item"><a href="#using-a-repo">Using a repo</a></li>
                      </ul>
                    </div>
                </div>
            </div>
            <div class="content">
              <article>
                <a class="source-button" href="" title="Edit this page"><svg xmlns="http://www.w3.org/2000/svg" width="30px" height="30px" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"></path></svg></a>
                <a class="source-button" href="local_git_server.md" title="View source of this page"><svg xmlns="http://www.w3.org/2000/svg" width="30px" height="30px" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"></path></svg></a>
                <br>
                <h1 id="setup-a-home-git-server">Setup a Home Git Server</h1>
<h3 class="subtitle" id="your-own-personal-private-git-server-in-your-home"><em>Your own personal, private Git server in your home!</em></h3>
<h2 class="template__section" id="features">Features</h2>
<p>A local, private, free git server.</p>
<p>HTTP acces to Gitweb interface in a web browser; local use of <code>gitk</code> and <code>git-gui</code> graphical interfaces that are bundled with git.</p>
<p>HTTP access can be either authenticated (requires username and password), or unauthenticated.</p>
<p>Git repositories can be stored on the server somewhere having a long path name, e.g. <code>/mnt/my-raid/www/git/repos</code>, but accessed with a shorter path, e.g. <code>/git</code>, by using a symbolic link.</p>
<p>The HTTP URL usage is a lot like using GitHub or GitLab.</p>
<p>Can also fully interact with the git server using SSH (slightly more complicated URL) without a password.</p>
<p>Do not need to enter the server to create new repos. Can either use passwordless-SSH, or a PHP form over HTTP in a web browser.</p>
<p>The PHP form sanitizes the input, returns a message if the repo name is already used on the server, and returns an error message if the wrong format has been given for the repo name.</p>
<h2 class="template__section" id="machines">Machines</h2>
<h3 id="server">Server</h3>
<p>A Raspberry Pi 5 8Gb machine having:</p>
<ul>
<li>Raspberry Pi Lite OS (Debian Bookworm)</li>
<li>RAID storage</li>
</ul>
<h3 id="clients">Clients</h3>
<p>Local machines running one of:</p>
<ul>
<li>Raspberry Pi OS</li>
<li>Windows 11</li>
<li>MacOS</li>
</ul>
<h2 class="template__section" id="software-used">Software used</h2>
<ul>
<li>NGINX</li>
<li>Git</li>
<li>Gitweb</li>
<li>fcgiwrap</li>
<li>apache2-utils</li>
<li>PHP-FPM</li>
</ul>
<h2 class="template__section" id="minimal-config">Minimal config</h2>
<p>Note both sytem and global configs:</p>
<pre><code class="language-bash">$ git config --global user.name &quot;&lt;user&gt;&quot;
$ git config --global user.email &lt;email address&gt;

$ git config --system init.defaultBranch master
</code></pre>
<h2 class="template__section" id="repo-root">Repo root</h2>
<p>Create and configure a directory to house repositories.</p>
<p>I used <code>/mnt/raid10/git</code> as <code>&lt;repo-root&gt;</code>.</p>
<p>We make the git root directory, <code>&lt;repo-root&gt;</code>, user and group the same as needed for using the HTML interface, and give this useer and group full permissions, but others only read and execute permissions.</p>
<pre><code class="language-bash">$ sudo mkdir &lt;repo-root&gt;
$ sudo chown -R www-data:www-data &lt;repo-root&gt;
$ sudo chmod -R 775  &lt;repo-root&gt;
</code></pre>
<p>Give it a shorter symbolic link.</p>
<pre><code class="language-bash">$ sudo ln -s &lt;repo-root&gt; /git
</code></pre>
<p>Do NOT do <code>mkdir /git</code> first, just run the <code>ln -s</code> command.</p>
<h2 class="template__section" id="gitweb-config">Gitweb Config</h2>
<p>I used:</p>
<p><code>&lt;repo-root&gt; = /mnt/raid10/git</code></p>
<p>In the gitweb config file</p>
<pre><code class="language-bash">/etc/gitweb.conf
</code></pre>
<p>change the value of <code>$projectroot</code></p>
<pre><code class="language-bash"># path to git projects (&lt;project&gt;.git)
#$projectroot = &quot;/var/lib/git&quot;;
$projectroot = &quot;&lt;repo-root&gt;&quot;;
</code></pre>
<p>Contents of this file before our major, final reinstall:</p>
<pre><code class="language-bash">pis@radxahost:~ $ cat /etc/gitweb.conf
# path to git projects (&lt;project&gt;.git)
#$projectroot = &quot;/var/lib/git&quot;;
#$projectroot = &quot;/var/www/html/git&quot;;
$projectroot = &quot;/mnt/raid1/git&quot;;

# directory to use for temp files
$git_temp = &quot;/tmp&quot;;

# target of the home link on top of all pages
#$home_link = $my_uri || &quot;/&quot;;

# html text to include at home page
#$home_text = &quot;indextext.html&quot;;

# file with project list; by default, simply scan the projectroot dir.
#$projects_list = $projectroot;

# stylesheet to use
#@stylesheets = (&quot;static/gitweb.css&quot;);
#@stylesheets = (&quot;/usr/share/gitweb/static/gitweb.css&quot;);

# javascript code for gitweb
#$javascript = &quot;static/gitweb.js&quot;;
#$javascript = &quot;/usr/share/gitweb/static/gitweb.js&quot;;

# logo to use
#$logo = &quot;static/git-logo.png&quot;;
#$logo = &quot;/usr/share/gitweb/static/git.logo.png&quot;;

# the 'favicon'
#$favicon = &quot;static/git-favicon.png&quot;;
#$favicon = &quot;/usr/share/gitweb/static/git-favicon.png&quot;;

# git-diff-tree(1) options to use for generated patches
#@diff_opts = (&quot;-M&quot;);
@diff_opts = ();
</code></pre>
<h2 class="template__section" id="creating-a-new-repo">Creating a new repo</h2>
<p>I used:</p>
<pre><code>&lt;repo-root&gt; = /mnt/raid10/git
&lt;gitweb-root&gt; = /usr/share/gitweb which I believe is the default for Gitweb.
&lt;hostname&gt; = intra
</code></pre>
<h2 class="template__section" id="ssh-without-a-password">SSH without a password</h2>
<p>Since we already setup SSH without a password, we can do this:</p>
<pre><code class="language-bash">$ ssh user@server git init --bare &lt;project&gt;.git
</code></pre>
<p>e.g.</p>
<pre><code>$ ssh [user@]&lt;hostname&gt; git init --bare --share /path/to/project.git
</code></pre>
<h2 class="template__section" id="httpphp-form">HTTP/PHP Form</h2>
<p>Here we create a PHP form accessed at <code>http://&lt;hostname&gt;.local/newrepo</code> that can be used to create a new repo over the LAN.</p>
<p>Ref: https://www.theserverside.com/blog/Coffee-Talk-Java-News-Stories-and-Opinions/Nginx-PHP-FPM-config-example</p>
<p>If not already installed, install PHP <strong>fpm</strong> version and restart NGINX:</p>
<pre><code class="language-bash">$ sudo apt-get install php8.2-fpm -y
$ sudo systemctl restart nginx
</code></pre>
<p>Create and configure the following directory:</p>
<pre><code class="language-bash">$ mkdir &lt;gitweb-root&gt;/newrepo

$ chown -R www-data:www-data &lt;gitweb-root&gt;/newrepo

$ chmod -R 755 &lt;gitweb-root&gt;/newrepo
</code></pre>
<p>Create a bash script <code>&lt;gitweb-root&gt;/newrepo/create_repo.sh</code> with the following contents:</p>
<pre><code class="language-bash">#!/usr/bin/env bash

mkdir /mnt/raid10/git/$1.git

cd /mnt/raid10/git/$1.git

git init --bare --share=group

git update-server-info

chgrp -R www-data .
chmod -R g+rw .
find -type d -exec chmod g+s {} +
</code></pre>
<p>and configure it to be executable:</p>
<pre><code class="language-bash">$ chmod +x &lt;gitweb-root&gt;/newrepo/create_repo.sh
</code></pre>
<p>and make sure all SSH users are in the <code>www-data</code> group, e.g. do</p>
<pre><code class="language-bash">$ sudo usermod -a -G www-data &lt;git-user&gt;
</code></pre>
<p>for each git user.</p>
<p>Create a php file <code>&lt;gitweb-root&gt;/newrepo/index.php</code> with the following contents:</p>
<pre><code class="language-php">&lt;!DOCTYPE HTML&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Create New Repository&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;?php
      session_start();
    ?&gt;
    &lt;a href=&quot;/&quot;&gt;Return to Home Page&lt;/a&gt;
    &lt;h3&gt;Create a New Repository&lt;/h3&gt;
    &lt;form method=&quot;post&quot; action=&quot;/newrepo/newrepoexe.php&quot;&gt;
      Name: &lt;input type=&quot;text&quot; name=&quot;name&quot;&gt;
      &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;Create Repo&quot;&gt;
    &lt;/form&gt;
    &lt;?php
      echo &quot;&lt;br&gt;&lt;br&gt;&quot;;
      if($_SESSION['name_submitted'] != &quot;&quot;){
        print_r($_SESSION['output']);
      }
      $_SESSION['name_submitted'] = &quot;&quot;;
    ?&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>and another php file <code>&lt;gitweb-root&gt;/newrepo/newrepoexe.php</code> with the following contents:</p>
<pre><code class="language-php">&lt;?php
  session_start();
  function test_input($data) {
    $data = trim($data);
    $data = stripslashes($data);
    $data = htmlspecialchars($data);
    return $data;
  }
  $name = test_input($_POST[&quot;name&quot;]);
  $_SESSION['name_submitted'] = $name;
  $_SESSION['output'] = null;
  $_SESSION['retval'] = null;
  $correct_format = preg_match(&quot;/^[A-Za-z0-9_-]+$/&quot;, $name);
  $existing_repos = file_get_contents('http://&lt;hostname&gt;.local/index.cgi?a=project_index');
  $is_in_existing_repo_list = preg_match(&quot;/&quot; . $name . &quot;.git&quot; . &quot;/i&quot; , $existing_repos);
  if ($correct_format &amp; !$is_in_existing_repo_list) {
      exec(&quot;/usr/share/gitweb/newrepo/create_repo.sh $name 2&gt;&amp;1&quot;, $output, $retval);
  }
  if(!$correct_format){
      $output = 'Name: ' . $name . '&lt;br&gt;Error: repo name can only include letters, numbers, underscores, and dashes.';
      $retval = 1;
  }
  if($is_in_existing_repo_list){
      $output = 'Error: a repo named ' . $name . ' already exists.';
      $retval = 1;
  }
  $_SESSION['output'] = $output;
  $_SESSION['retval'] = $retval;
  header(&quot;Location: /newrepo/index.php&quot;);
?&gt;
</code></pre>
<p>You should now be able to go to </p>
<p><code>http://&lt;hostname&gt;.local/newrepo</code></p>
<p>in a web browser on a machine on the same network and use the form to create a new repo.</p>
<p>Any new repos made with this form should show up on the gitweb homepage.</p>
<h2 class="template__section" id="finalize">Finalize</h2>
<p>After a repo has been created on the server with either method above, it is necessary to push a non-empty repo to it before doing any cloning or pulling from it. </p>
<p>We do this from another machine using either an existing repo or making a minimal non-empty repo:</p>
<pre><code class="language-bash">$ mkdir ~/testproject
$ cd ~/testproject
$ git init
$ git remote add origin http://&lt;hostname&gt;.local/git/&lt;project-name&gt;.git
$ touch README.md
$ git add .
$ git commit -a -m &quot;some message&quot;
$ git push origin master
</code></pre>
<h2 class="template__section" id="using-a-repo">Using a repo</h2>
<p>After a <strong><em>non-empty</em></strong> project has been pushed to a new repo on the server, other users can clone or pull it.</p>
<pre><code class="language-bash">$ git clone http://&lt;hostname&gt;.local/git/&lt;project&gt;.git
</code></pre>
<pre><code class="language-bash">$ mkdir ~/testproject
$ cd ~/testproject
$ git init
$ git remote add origin http://&lt;hostname&gt;.local/git/&lt;project&gt;.git
$ git pull origin master
</code></pre>
<p>Note that on Windows it might work better to use the user-URL like:</p>
<pre><code class="language-bash">$ git clone http://&lt;user&gt;@&lt;hostname&gt;.local/git/&lt;project-name&gt;.git
# or 
$ mkdir ~/testproject
$ cd ~/testproject
$ git init
$ git remote add origin http://&lt;user&gt;@&lt;hostname&gt;.local/git/&lt;project&gt;.git
$ git pull origin master
</code></pre>
                <p class="outro">To suggest an edit or correction to this page, please click the "Edit this page" button below or at the top to access the source file on GitHub.</p>
                <br>
                <div class="source-button-bottom">
                  <div class="source-button-bottom-inner">
                    <a id="a" class="source-button" href="local_git_server.md" title="View source of this page"><svg xmlns="http://www.w3.org/2000/svg" width="50px" height="50px" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"></path></svg></a>
                    <label id="b">View</label>
                  </div>
                  <div class="source-button-bottom-inner">
                    <a id="c" class="source-button" href="" title="Edit this page"><svg xmlns="http://www.w3.org/2000/svg" width="50px" height="50px" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"></path></svg></a>
                    <label id="d">Edit</label>
                  </div>
                </div>
              </article>
            </div>
        </div>
    </main>
    <footer class="footer">
      <!--<div><p>All content copyright Hylown</p></div>-->
      <div><a href="tou.html">Terms of Use</a></div>
      <div><a href="https://hylown.com"><img src="assets/portal.png" width="100px" height="100px"></a></div>
      <div><a href="">back to top</a></div>
    </footer>
  </div>
  <script>
    document.getElementById('LocalGitServer').classList.add('active')
  </script>
  <script src="assets/javascript/hylowncom.js"></script>
</body>
</html>